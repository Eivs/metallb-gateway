========================================
  MetalLB Gateway å®‰è£…å®Œæˆï¼
========================================

æ„Ÿè°¢æ‚¨å®‰è£… MetalLB Gatewayã€‚

ğŸ“¦ å®‰è£…çš„ç»„ä»¶:
  - MetalLB ({{ .Values.metallb.controller.image.tag }})
  - Traefik ({{ .Values.traefik.image.tag }})
  - Gateway API CRDs

ğŸ”§ è·å– LoadBalancer IP:

MetalLB å·²é…ç½®ä»¥ä¸‹ IP åœ°å€æ± :
{{- range .Values.metallb.ipAddressPools }}
  â€¢ {{ .name }}: {{ .addresses }}
{{- end }}

è¦åˆ›å»ºä¸€ä¸ª LoadBalancer ç±»å‹çš„æœåŠ¡ï¼Œä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹ï¼š

  apiVersion: v1
  kind: Service
  metadata:
    name: example-service
  spec:
    type: LoadBalancer
    selector:
      app: example
    ports:
      - port: 80
        targetPort: 8080

ğŸŒ ä½¿ç”¨ Gateway API:

Traefik GatewayClass å·²å®‰è£…ï¼Œåç§°ä¸º: {{ .Release.Name }}-traefik

åˆ›å»º Gateway ç¤ºä¾‹ï¼š

  apiVersion: gateway.networking.k8s.io/v1
  kind: Gateway
  metadata:
    name: example-gateway
  spec:
    gatewayClassName: {{ .Release.Name }}-traefik
    listeners:
      - name: web
        port: 80
        protocol: HTTP

ğŸ“Š Traefik Dashboard:

æœ¬åœ°è®¿é—®:
  kubectl port-forward -n {{ include "metallb-gateway.namespace" . }} deployment/{{ .Release.Name }}-traefik 9000:9000
  ç„¶åè®¿é—®: http://localhost:9000/dashboard/

é€šè¿‡ LoadBalancer è®¿é—®:
  è·å–å¤–éƒ¨ IP: kubectl get svc -n {{ include "metallb-gateway.namespace" . }} {{ .Release.Name }}-traefik
  è®¿é—®: http://<EXTERNAL-IP>:9000/dashboard/

âš™ï¸ é…ç½®æ–‡ä»¶:

å¦‚éœ€ä¿®æ”¹ IP åœ°å€æ± æˆ–å…¶ä»–é…ç½®ï¼Œç¼–è¾‘ values.yaml:

  metallb:
    ipAddressPools:
      - name: default-pool
        addresses:
          - 192.168.1.100-192.168.1.200  # ä¿®æ”¹ä¸ºä½ çš„ IP èŒƒå›´

ç„¶åå‡çº§:
  helm upgrade {{ .Release.Name }} . -f values.yaml

ğŸ“š æ›´å¤šä¿¡æ¯:

  - MetalLB æ–‡æ¡£: https://metallb.universe.tf/
  - Traefik æ–‡æ¡£: https://doc.traefik.io/traefik/
  - Gateway API æ–‡æ¡£: https://gateway-api.sigs.k8s.io/

{{- if .Values.metallb.enabled }}
ğŸ’¡ æç¤º:

MetalLB Speaker æ­£åœ¨è¿è¡Œã€‚æ£€æŸ¥çŠ¶æ€:

  kubectl get pods -n {{ include "metallb-gateway.namespace" . }} | grep speaker
  kubectl logs -n {{ include "metallb-gateway.namespace" . }} deployment/{{ .Release.Name }}-metallb-controller
{{- end }}

{{- if .Values.traefik.enabled }}
ğŸš€ å¿«é€Ÿå¼€å§‹:

1. åˆ›å»ºä¸€ä¸ªæµ‹è¯•åº”ç”¨:
   kubectl create deployment test --image=nginx -n {{ include "metallb-gateway.namespace" . }}

2. æš´éœ²ä¸º LoadBalancer:
   kubectl expose deployment test --port=80 --type=LoadBalancer -n {{ include "metallb-gateway.namespace" . }}

3. è·å–å¤–éƒ¨ IP:
   kubectl get svc test -n {{ include "metallb-gateway.namespace" . }}
{{- end }}

{{- if .Values.whoami.enabled }}
âœ… Whoami ç¤ºä¾‹åº”ç”¨å·²å®‰è£…!

ğŸ¯ éªŒè¯ MetalLB (LoadBalancer):

1. è·å– whoami çš„å¤–éƒ¨ IP:
   export WHOAMI_IP=$(kubectl get svc whoami -n {{ include "metallb-gateway.namespace" . }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

2. è®¿é—®åº”ç”¨ (å¤šæ¬¡è°ƒç”¨å¯ä»¥çœ‹åˆ°ä¸åŒ Pod å“åº”):
   curl http://${WHOAMI_IP}/

   æˆ–è€…ä½¿ç”¨æµè§ˆå™¨è®¿é—®: http://${WHOAMI_IP}/

ğŸŒ éªŒè¯ Gateway API:

1. è·å– Traefik Gateway å¤–éƒ¨ IP:
   export GATEWAY_IP=$(kubectl get svc -n {{ include "metallb-gateway.namespace" . }} {{ .Release.Name }}-traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

2. é…ç½®æœ¬åœ° hosts æ–‡ä»¶ (å¯é€‰):
   echo "${GATEWAY_IP} {{ .Values.whoami.gateway.host }}" | sudo tee -a /etc/hosts

3. é€šè¿‡ Gateway è®¿é—®:
   curl -H "Host: {{ .Values.whoami.gateway.host }}" http://${GATEWAY_IP}/

   æˆ–åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://{{ .Values.whoami.gateway.host }}/

ğŸ“Š æŸ¥çœ‹ç¤ºä¾‹åº”ç”¨çŠ¶æ€:

  kubectl get pods,svc,gateway,httproute -n {{ include "metallb-gateway.namespace" . }} | grep whoami

ğŸ§¹ æ¸…ç†ç¤ºä¾‹åº”ç”¨:

  helm upgrade {{ .Release.Name }} . --set whoami.enabled=false

  æˆ–æ‰‹åŠ¨åˆ é™¤:
  kubectl delete deployment,service,gateway,httproute -l app=whoami -n {{ include "metallb-gateway.namespace" . }}
{{- end }}
